<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Weekmenu">
<meta name="theme-color" content="#FAF7F2">
<title>Weekmenu</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{height:-webkit-fill-available}
body{min-height:100vh;min-height:-webkit-fill-available;background:#FAF7F2;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:#3D405B;overscroll-behavior:none}
input,select,textarea,button{font-family:inherit;font-size:inherit}
button{cursor:pointer;border:none;background:none}

.app{max-width:480px;margin:0 auto;min-height:100vh;min-height:-webkit-fill-available;display:flex;flex-direction:column}
.header{display:flex;align-items:center;gap:10px;padding:16px 20px 8px;background:#FAF7F2;position:sticky;top:0;z-index:50}
.header-emoji{font-size:28px}
.header-title{font-size:20px;font-weight:700;flex:1}
.header-week{font-size:13px;color:#999;font-weight:500}
.main{flex:1;padding:0 16px 100px;overflow-y:auto}

/* Nav */
.nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:480px;display:flex;justify-content:space-around;background:#fff;border-top:1px solid #ede8e0;padding:8px 0 max(8px, env(safe-area-inset-bottom));z-index:100}
.nav-btn{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;border-radius:12px;transition:all .2s;background:none;border:none}
.nav-btn svg{transition:all .2s}
.nav-label{font-size:10px;font-weight:600}
.nav-btn.active{background:#F0EDE6}

/* Toast */
.toast{position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#3D405B;color:#fff;padding:10px 20px;border-radius:20px;font-size:14px;font-weight:600;z-index:200;animation:slideDown .3s ease;pointer-events:none;white-space:nowrap}

/* Cards */
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
.section-title{font-size:17px;font-weight:700;margin-bottom:12px}
.hint{font-size:12px;color:#999;margin-bottom:8px}

/* Buttons */
.btn-primary{background:#E07A5F;color:#fff;border:none;border-radius:14px;padding:14px 20px;font-size:15px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px;width:100%}
.btn-primary:active{opacity:.85}
.btn-secondary{background:#81B29A;color:#fff;border:none;border-radius:14px;padding:14px 20px;font-size:15px;font-weight:700;display:flex;align-items:center;justify-content:center;gap:8px;width:100%}
.btn-small{background:#F0EDE6;color:#3D405B;border:none;border-radius:10px;padding:8px 14px;font-size:13px;font-weight:600}
.btn-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:none;border:none}
.btn-icon:active{background:#F0EDE6}
.btn-tiny{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:none;border:none;touch-action:manipulation}
.btn-tiny svg,.btn-icon svg{pointer-events:none}

/* Tags */
.tag{display:inline-block;padding:4px 10px;border-radius:8px;font-size:12px;font-weight:600;background:#F0EDE6;color:#81B29A;margin:2px}
.tag-small{font-size:11px;padding:2px 8px;border-radius:6px;background:#F0EDE6;color:#81B29A;display:inline-block;margin:1px}

/* Forms */
.form-card{background:#fff;border-radius:16px;padding:16px;margin-bottom:12px}
.label{font-size:13px;font-weight:600;color:#999;display:block;margin:12px 0 6px}
.input{width:100%;padding:12px 14px;border:2px solid #ede8e0;border-radius:12px;font-size:14px;background:#FAF7F2;outline:none;transition:border-color .2s}
.input:focus{border-color:#81B29A}
.select{width:100%;padding:12px 14px;border:2px solid #ede8e0;border-radius:12px;font-size:14px;background:#FAF7F2;outline:none;-webkit-appearance:none}

/* Tag selector */
.tag-select{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.tag-option{padding:6px 12px;border-radius:10px;font-size:13px;font-weight:600;border:2px solid #ede8e0;background:#fff;color:#999;transition:all .15s}
.tag-option.active{background:#81B29A;color:#fff;border-color:#81B29A}

/* Menu cards */
.menu-card{background:#fff;border-radius:14px;padding:14px 16px;margin-bottom:8px;box-shadow:0 1px 3px rgba(0,0,0,.04);transition:all .3s;border-left:4px solid transparent}
.menu-card.locked{border-left-color:#E07A5F}
.menu-card-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.menu-day{font-size:12px;font-weight:700;color:#999;text-transform:uppercase;letter-spacing:.5px}
.menu-dish{font-size:15px;font-weight:600;color:#3D405B}
.pref-badge{font-size:10px;background:#F2CC8F;color:#3D405B;padding:2px 8px;border-radius:6px;font-weight:600;margin-left:6px}

/* Dish list */
.dish-item{background:#fff;border-radius:14px;padding:14px 16px;margin-bottom:8px;box-shadow:0 1px 3px rgba(0,0,0,.04);display:flex;align-items:flex-start;gap:12px}
.dish-item.inactive{opacity:.5}
.dish-info{flex:1;min-width:0}
.dish-name{font-size:15px;font-weight:600;margin-bottom:4px}
.dish-actions{display:flex;gap:4px;flex-shrink:0}
.ing-row{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.ing-chip{font-size:11px;color:#999;background:#F9F6F1;padding:2px 6px;border-radius:4px}

/* Shopping */
.shop-item{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid #f0ede6}
.shop-check{width:22px;height:22px;border-radius:7px;border:2px solid #ddd;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s}
.shop-check.checked{background:#81B29A;border-color:#81B29A}
.shop-name{flex:1;font-size:14px;font-weight:500}
.shop-name.checked{text-decoration:line-through;color:#ccc}
.shop-cat{font-size:11px;color:#bbb;font-weight:500}
.shop-cat-header{font-size:12px;font-weight:700;color:#81B29A;text-transform:uppercase;letter-spacing:.5px;padding:12px 0 4px;margin-top:8px}

/* Modal */
.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.45);z-index:100;display:flex;align-items:flex-end;justify-content:center;animation:fadeIn .2s ease}
.modal-overlay.center{align-items:center}
.modal-content{background:#FAF7F2;border-radius:20px 20px 0 0;width:100%;max-width:480px;max-height:80vh;display:flex;flex-direction:column;animation:slideUp .3s ease}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px 8px;border-bottom:1px solid #ede8e0}
.modal-title{font-size:16px;font-weight:700;color:#3D405B;margin:0}
.picker-search{margin:12px 20px;padding:10px 14px;border-radius:12px;border:2px solid #ede8e0;font-size:14px;background:#fff;width:calc(100% - 40px);outline:none}
.picker-search:focus{border-color:#81B29A}
.picker-list{flex:1;overflow-y:auto;padding:0 12px 20px}
.picker-item{display:block;width:100%;text-align:left;padding:12px 14px;margin:4px 0;border-radius:12px;border:none;cursor:pointer;background:none;transition:background .15s}
.picker-item:active{background:#F0EDE6}
.picker-dish-name{font-size:14px;font-weight:600;color:#3D405B;margin-bottom:2px}
.picker-ingredients{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
.picker-ing{font-size:11px;color:#999}
.picker-ing.match{color:#E07A5F;font-weight:600}

/* Delete confirm */
.confirm-box{background:#fff;border-radius:16px;padding:24px;margin:auto;width:85%;max-width:340px;box-shadow:0 8px 32px rgba(0,0,0,.15);text-align:center}
.confirm-title{font-size:16px;font-weight:700;margin-bottom:8px}
.confirm-msg{font-size:14px;color:#666;margin-bottom:20px}
.confirm-btns{display:flex;gap:10px;justify-content:center}
.confirm-btns button{flex:1;padding:12px;border-radius:12px;font-weight:700;font-size:14px;border:none}
.confirm-cancel{background:#F0EDE6;color:#3D405B}
.confirm-delete{background:#E07A5F;color:#fff}

/* Settings cooking days */
.cooking-days{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0 16px}
.day-toggle{width:44px;height:38px;border-radius:10px;font-size:13px;font-weight:700;border:2px solid #ede8e0;background:transparent;color:#999;transition:all .15s}
.day-toggle.active{background:#81B29A;color:#fff;border-color:#81B29A}

/* History */
.history-card{background:#fff;border-radius:12px;padding:12px 16px;margin-bottom:8px;font-size:13px}
.history-week{font-weight:700;color:#81B29A;margin-bottom:4px}
.history-day{color:#666;padding:2px 0}

/* Autocomplete */
.autocomplete{position:absolute;left:0;right:0;background:#fff;border:2px solid #ede8e0;border-top:none;border-radius:0 0 12px 12px;max-height:180px;overflow-y:auto;z-index:10}
.ac-item{padding:10px 14px;font-size:14px;cursor:pointer;display:flex;justify-content:space-between;touch-action:manipulation}
.ac-item:active{background:#F0EDE6}
.ac-cat{font-size:11px;color:#bbb}

/* Search bar */
.search-bar{width:100%;padding:10px 14px 10px 36px;border:2px solid #ede8e0;border-radius:12px;font-size:14px;background:#fff;outline:none;margin-bottom:12px;transition:border-color .2s}
.search-bar:focus{border-color:#81B29A}
.search-wrap{position:relative;margin-bottom:4px}
.search-icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);pointer-events:none}

/* Empty state */
.empty{text-align:center;padding:40px 20px;color:#bbb}
.empty-emoji{font-size:48px;margin-bottom:12px}
.empty-text{font-size:15px;font-weight:500}
.empty-hint{font-size:13px;color:#ccc;margin-top:6px}

/* Filter row */
.filter-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}

/* Loading */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:16px}
.loading-emoji{font-size:48px;animation:pulse 1.5s infinite}
.loading-text{font-size:15px;color:#999;font-weight:500}

/* Animations */
@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
@keyframes menuPop{0%{transform:scale(.95);opacity:.7}100%{transform:scale(1);opacity:1}}
</style>
</head>
<body>
<div id="root"></div>
<script>
// ‚îÄ‚îÄ‚îÄ Supabase Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPABASE_URL = 'https://vinhazunzttsrzwahbkl.supabase.co';   // bv. https://xxxx.supabase.co
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpbmhhenVuenR0c3J6d2FoYmtsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3MTA1MTEsImV4cCI6MjA4NzI4NjUxMX0.jbr6YfC8wRYAdspXAePTvTjaYWLWtKTEzY6KI5lBVKQ';      // anon public key

// ‚îÄ‚îÄ‚îÄ Supabase Client (lightweight, geen SDK nodig) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const sb = {
  _headers: { 'apikey': SUPABASE_ANON, 'Authorization': 'Bearer ' + SUPABASE_ANON, 'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates' },
  async get(key) {
    try {
      const r = await fetch(`${SUPABASE_URL}/rest/v1/app_state?key=eq.${key}&select=data`, { headers: this._headers });
      if (!r.ok) return null;
      const rows = await r.json();
      return rows.length ? rows[0].data : null;
    } catch(e) { return null; }
  },
  async set(key, data) {
    try {
      const r = await fetch(`${SUPABASE_URL}/rest/v1/app_state`, {
        method: 'POST',
        headers: { ...this._headers, 'Prefer': 'resolution=merge-duplicates' },
        body: JSON.stringify({ key, data })
      });
      return r.ok;
    } catch(e) { return false; }
  },
  subscribe(onUpdate) {
    // Realtime via WebSocket ‚Äî Supabase Realtime v2 protocol
    const wsUrl = SUPABASE_URL.replace('https://', 'wss://').replace('http://', 'ws://')
      + '/realtime/v1/websocket?apikey=' + SUPABASE_ANON + '&vsn=1.0.0';
    let ws, pingTimer, ref = 0;
    function send(obj){ if(ws && ws.readyState===1) ws.send(JSON.stringify(obj)); }
    function connect() {
      try {
        ws = new WebSocket(wsUrl);
        ws.onopen = () => {
          ref++;
          // Subscribe op postgres_changes voor INSERT en UPDATE
          send({
            topic: 'realtime:public:app_state',
            event: 'phx_join',
            payload: {
              config: {
                broadcast: { self: false },
                postgres_changes: [
                  { event: 'INSERT', schema: 'public', table: 'app_state' },
                  { event: 'UPDATE', schema: 'public', table: 'app_state' }
                ]
              }
            },
            ref: String(ref)
          });
          pingTimer = setInterval(() => {
            ref++;
            send({ topic: 'phoenix', event: 'heartbeat', payload: {}, ref: String(ref) });
          }, 25000);
        };
        ws.onmessage = (e) => {
          try {
            const msg = JSON.parse(e.data);
            // Realtime v2: postgres_changes event, record in payload.data.record
            if (msg.event === 'postgres_changes') {
              const record = msg.payload?.data?.record;
              if (record) onUpdate(record);
            }
            // Fallback voor oudere protocol
            else if (msg.event === 'INSERT' || msg.event === 'UPDATE') {
              const record = msg.payload?.record;
              if (record) onUpdate(record);
            }
          } catch(err) {}
        };
        ws.onclose = () => { clearInterval(pingTimer); setTimeout(connect, 5000); };
        ws.onerror = () => { try{ ws.close(); }catch(e){} };
      } catch(e) {}
    }
    connect();
  }
};

// Sync status: 'ok' | 'syncing' | 'offline'
let syncStatus = 'offline';

// ‚îÄ‚îÄ‚îÄ SVG Icons ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const IC={
home:'M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z M9 22V12h6v10',
dish:'M3 6h18 M3 6c0 7.2 3.6 12 9 12s9-4.8 9-12 M12 18v4 M8 22h8',
cart:'M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z M3 6h18 M16 10a4 4 0 01-8 0',
settings:'M12 15a3 3 0 100-6 3 3 0 000 6z M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 114 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z',
plus:'M12 5v14 M5 12h14',
x:'M18 6L6 18 M6 6l12 12',
check:'M20 6L9 17l-5-5',
refresh:'M23 4v6h-6 M1 20v-6h6 M3.51 9a9 9 0 0114.85-3.36L23 10 M1 14l4.64 4.36A9 9 0 0020.49 15',
edit:'M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7 M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z',
trash:'M3 6h18 M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2 M10 11v6 M14 11v6',
lock:'M19 11H5a2 2 0 00-2 2v7a2 2 0 002 2h14a2 2 0 002-2v-7a2 2 0 00-2-2z M7 11V7a5 5 0 0110 0v4',
unlock:'M19 11H5a2 2 0 00-2 2v7a2 2 0 002 2h14a2 2 0 002-2v-7a2 2 0 00-2-2z M7 11V7a5 5 0 019.9-1',
dice:'M4 4h16v16H4z M8 8h.01 M16 8h.01 M8 16h.01 M16 16h.01 M12 12h.01',
chevDown:'M6 9l6 6 6-6',
history:'M12 8v4l3 3 M3.05 11a9 9 0 11.5 4m-.5-4H1l2-3 2 3H3.05',
search:'M11 17.25a6.25 6.25 0 110-12.5 6.25 6.25 0 010 12.5z M16 16l4.5 4.5',
pencil:'M17 3a2.83 2.83 0 114 4L7.5 20.5 2 22l1.5-5.5z',
};
function icon(name,size,color){size=size||20;color=color||'currentColor';return `<svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${IC[name]||''}"/></svg>`;}

// ‚îÄ‚îÄ‚îÄ Constants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DAYS=["Maandag","Dinsdag","Woensdag","Donderdag","Vrijdag","Zaterdag","Zondag"];
const DAYS_SHORT=["Ma","Di","Wo","Do","Vr","Za","Zo"];
const TAG_OPTIONS=["pasta","rijst","aardappelen","frietjes","ovenschotel","soep","salade","brood","vis","vlees","veggie","aziatisch","mexicaans","simpel","feestelijk"];
const ING_CATS=["groenten","fruit","vlees","vis","zuivel","droog","sauzen","kruiden","overig"];

// ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const genId=()=>Math.random().toString(36).substring(2,10)+Date.now().toString(36);
function getWeekNumber(d){const dt=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));const dn=dt.getUTCDay()||7;dt.setUTCDate(dt.getUTCDate()+4-dn);const ys=new Date(Date.UTC(dt.getUTCFullYear(),0,1));return Math.ceil(((dt-ys)/86400000+1)/7);}
function esc(s){if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// ‚îÄ‚îÄ‚îÄ Storage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// localStorage als fallback en cache
function loadLocal(key,fb){try{const r=localStorage.getItem(key);return r?JSON.parse(r):fb;}catch(e){return fb;}}
function saveLocal(key,data){try{localStorage.setItem(key,JSON.stringify(data));}catch(e){}}

// Supabase key mapping
const SB_KEYS = { 'wm-dishes':'dishes','wm-menus':'menus','wm-shopping':'shopping','wm-prefs':'prefs','wm-taglimits':'taglimits','wm-cookingdays':'cookingdays' };

function load(key,fb){return loadLocal(key,fb);}

// Tel hoeveel eigen writes er nog een echo verwachten per key
const _ownWrites = {};

async function save(key,data){
  saveLocal(key,data);
  const sbKey = SB_KEYS[key];
  if(!sbKey) return;
  if(SUPABASE_URL==='JOUW_SUPABASE_URL') return; // niet geconfigureerd
  setSyncStatus('syncing');
  _ownWrites[sbKey] = (_ownWrites[sbKey] || 0) + 1;
  const ok = await sb.set(sbKey, data);
  setSyncStatus(ok ? 'ok' : 'offline');
}

function setSyncStatus(s){
  syncStatus=s;
  // Kleur direct updaten zonder volledige re-render (indicator is altijd in DOM)
  const colors={'ok':'#81B29A','syncing':'#F2CC8F','offline':'#E07A5F'};
  const labels={'ok':'Gesynchroniseerd','syncing':'Synchroniseren...','offline':'Offline (lokaal opgeslagen)'};
  const el=document.getElementById('sync-indicator');
  if(el){
    el.style.background=colors[s]||'#bbb';
    el.title=labels[s]||s;
  }
}

// Laad data van Supabase bij opstart
async function loadFromSupabase(){
  if(SUPABASE_URL==='JOUW_SUPABASE_URL') return;
  setSyncStatus('syncing');
  const keys = [
    ['dishes','wm-dishes',DEFAULT_DISHES],
    ['menus','wm-menus',[]],
    ['shopping','wm-shopping',null],
    ['prefs','wm-prefs',[]],
    ['taglimits','wm-taglimits',[]],
    ['cookingdays','wm-cookingdays',[0,1,2,3,4,5,6]],
  ];
  let anyOk = false;
  let changed = false;
  for(const [sbKey,localKey,fb] of keys){
    const data = await sb.get(sbKey);
    if(data !== null){
      anyOk = true;
      // Alleen updaten als de data werkelijk verschilt van huidige state
      const stateMap = { dishes:state.dishes, menus:state.menus, shopping:state.shopping, prefs:state.dayPrefs, taglimits:state.tagLimits, cookingdays:state.cookingDays };
      if(JSON.stringify(stateMap[sbKey]) !== JSON.stringify(data)){
        saveLocal(localKey, data);
        changed = true;
      }
    }
  }
  // Alleen renderen als er iets veranderd is √©n de gebruiker nog niet heeft ge√Ønterageerd
  // (zo vermijden we dat een trage Supabase-response een zojuist gegenereerd menu overschrijft)
  if(changed && !_appHasInteracted){
    state.dishes = loadLocal('wm-dishes', DEFAULT_DISHES);
    state.menus = loadLocal('wm-menus', []);
    state.shopping = loadLocal('wm-shopping', null);
    state.dayPrefs = loadLocal('wm-prefs', []);
    state.tagLimits = loadLocal('wm-taglimits', []);
    state.cookingDays = loadLocal('wm-cookingdays', [0,1,2,3,4,5,6]);
    render();
  }
  setSyncStatus(anyOk ? 'ok' : 'offline');
}

// ‚îÄ‚îÄ‚îÄ Default Dishes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DEFAULT_DISHES=[
{id:"d01",name:"Spaghetti Bolognese",tags:["pasta","vlees"],ingredients:[{name:"spaghetti",category:"droog"},{name:"gehakt",category:"vlees"},{name:"tomatenpassata",category:"sauzen"},{name:"ui",category:"groenten"},{name:"knoflook",category:"groenten"},{name:"wortel",category:"groenten"},{name:"parmezaan",category:"zuivel"}],isActive:true,createdAt:"2026-01-15"},
{id:"d02",name:"Kip Curry met Rijst",tags:["rijst","aziatisch"],ingredients:[{name:"kipfilet",category:"vlees"},{name:"rijst",category:"droog"},{name:"kokosmelk",category:"sauzen"},{name:"currypasta",category:"kruiden"},{name:"paprika",category:"groenten"},{name:"ui",category:"groenten"},{name:"sperziebonen",category:"groenten"}],isActive:true,createdAt:"2026-01-15"},
{id:"d03",name:"Frietjes met Stoofvlees",tags:["frietjes","vlees","feestelijk"],ingredients:[{name:"frieten",category:"overig"},{name:"runderstoofvlees",category:"vlees"},{name:"bier (bruin)",category:"overig"},{name:"ui",category:"groenten"},{name:"peperkoek",category:"overig"},{name:"mayonaise",category:"sauzen"}],isActive:true,createdAt:"2026-01-15"},
{id:"d04",name:"Ovenpasta met Broccoli",tags:["pasta","ovenschotel","veggie"],ingredients:[{name:"penne",category:"droog"},{name:"broccoli",category:"groenten"},{name:"room",category:"zuivel"},{name:"geraspte kaas",category:"zuivel"},{name:"knoflook",category:"groenten"},{name:"nootmuskaat",category:"kruiden"}],isActive:true,createdAt:"2026-01-15"},
{id:"d05",name:"Zalm met Aardappelpuree",tags:["vis","aardappelen"],ingredients:[{name:"zalmfilet",category:"vis"},{name:"aardappelen",category:"groenten"},{name:"boter",category:"zuivel"},{name:"melk",category:"zuivel"},{name:"citroen",category:"fruit"},{name:"dille",category:"kruiden"},{name:"sperziebonen",category:"groenten"}],isActive:true,createdAt:"2026-01-15"},
{id:"d06",name:"Taco's met Gekruid Gehakt",tags:["mexicaans","vlees"],ingredients:[{name:"tacoschelpen",category:"droog"},{name:"gehakt",category:"vlees"},{name:"sla",category:"groenten"},{name:"tomaat",category:"groenten"},{name:"geraspte kaas",category:"zuivel"},{name:"zure room",category:"zuivel"},{name:"paprikapoeder",category:"kruiden"},{name:"komijnpoeder",category:"kruiden"}],isActive:true,createdAt:"2026-01-15"},
{id:"d07",name:"Nasi Goreng",tags:["rijst","aziatisch"],ingredients:[{name:"rijst",category:"droog"},{name:"kipfilet",category:"vlees"},{name:"ei",category:"zuivel"},{name:"ketjap",category:"sauzen"},{name:"sambal",category:"sauzen"},{name:"prei",category:"groenten"},{name:"wortel",category:"groenten"},{name:"kroepoek",category:"overig"}],isActive:true,createdAt:"2026-01-15"},
{id:"d08",name:"Groentesoep",tags:["soep","veggie","simpel"],ingredients:[{name:"wortel",category:"groenten"},{name:"prei",category:"groenten"},{name:"aardappelen",category:"groenten"},{name:"courgette",category:"groenten"},{name:"bouillonblokje",category:"kruiden"},{name:"brood",category:"droog"}],isActive:true,createdAt:"2026-01-15"},
{id:"d09",name:"Wraps met Kip en Avocado",tags:["brood","vlees","simpel"],ingredients:[{name:"tortillawraps",category:"droog"},{name:"kipfilet",category:"vlees"},{name:"avocado",category:"groenten"},{name:"tomaat",category:"groenten"},{name:"sla",category:"groenten"},{name:"yoghurtsaus",category:"sauzen"}],isActive:true,createdAt:"2026-01-15"},
{id:"d10",name:"Stamppot Boerenkool",tags:["aardappelen","vlees","simpel"],ingredients:[{name:"aardappelen",category:"groenten"},{name:"boerenkool",category:"groenten"},{name:"rookworst",category:"vlees"},{name:"boter",category:"zuivel"},{name:"melk",category:"zuivel"},{name:"mosterd",category:"sauzen"}],isActive:true,createdAt:"2026-01-15"},
{id:"d11",name:"Lasagne",tags:["pasta","ovenschotel","vlees"],ingredients:[{name:"lasagnebladen",category:"droog"},{name:"gehakt",category:"vlees"},{name:"tomatenpassata",category:"sauzen"},{name:"bechamelsaus",category:"sauzen"},{name:"geraspte kaas",category:"zuivel"},{name:"ui",category:"groenten"},{name:"knoflook",category:"groenten"}],isActive:true,createdAt:"2026-01-15"},
{id:"d12",name:"Pad Thai",tags:["aziatisch","simpel"],ingredients:[{name:"rijstnoedels",category:"droog"},{name:"garnalen",category:"vis"},{name:"ei",category:"zuivel"},{name:"taug√©",category:"groenten"},{name:"pinda's",category:"overig"},{name:"limoen",category:"fruit"},{name:"vissaus",category:"sauzen"}],isActive:true,createdAt:"2026-01-15"},
{id:"d13",name:"Caesar Salade met Kip",tags:["salade","vlees"],ingredients:[{name:"romaine sla",category:"groenten"},{name:"kipfilet",category:"vlees"},{name:"parmezaan",category:"zuivel"},{name:"croutons",category:"droog"},{name:"caesardressing",category:"sauzen"},{name:"ei",category:"zuivel"}],isActive:true,createdAt:"2026-01-15"},
{id:"d14",name:"Risotto met Champignons",tags:["rijst","veggie","feestelijk"],ingredients:[{name:"risottorijst",category:"droog"},{name:"champignons",category:"groenten"},{name:"ui",category:"groenten"},{name:"witte wijn",category:"overig"},{name:"parmezaan",category:"zuivel"},{name:"boter",category:"zuivel"},{name:"bouillon",category:"kruiden"}],isActive:true,createdAt:"2026-01-15"},
{id:"d15",name:"Pannenkoeken",tags:["simpel","veggie"],ingredients:[{name:"bloem",category:"droog"},{name:"ei",category:"zuivel"},{name:"melk",category:"zuivel"},{name:"boter",category:"zuivel"},{name:"stroop",category:"sauzen"},{name:"spek",category:"vlees"}],isActive:true,createdAt:"2026-01-15"},
];

// ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state={
  tab:'home',
  dishes:load('wm-dishes',DEFAULT_DISHES),
  menus:load('wm-menus',[]),
  dayPrefs:load('wm-prefs',[]),
  shopping:load('wm-shopping',null),
  tagLimits:load('wm-taglimits',[]),
  cookingDays:load('wm-cookingdays',[0,1,2,3,4,5,6]),
  notification:null,
  // UI state
  dishForm:null,
  filterTag:null,
  dishSearch:'',
  pickerDay:null,
  pickerSearch:'',
  deleteTarget:null,
  settingsSection:'main',
};
// First time? save defaults
if(!localStorage.getItem('wm-dishes'))save('wm-dishes',DEFAULT_DISHES);

function setState(patch){Object.assign(state,patch);render();}
function notify(msg){state.notification=msg;render();setTimeout(()=>{state.notification=null;render();},2500);}

// ‚îÄ‚îÄ‚îÄ Menu Generation Algorithm ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateWeekMenu(dishes,recentDishIds,dayPreferences,tagLimits,cookingDays){
  tagLimits=tagLimits||[];cookingDays=cookingDays||[0,1,2,3,4,5,6];
  const active=dishes.filter(d=>d.isActive);
  if(!active.length)return null;
  const fresh=active.filter(d=>!recentDishIds.includes(d.id));
  let pool=fresh.length>=cookingDays.length?[...fresh]:[...active];
  const days=[];const used=new Set();const tagCounts={};
  for(const dayIdx of cookingDays){
    const pref=dayPreferences.find(p=>p.dayOfWeek===dayIdx);
    let cands=pool.filter(d=>!used.has(d.id));
    if(!cands.length)cands=active.filter(d=>!used.has(d.id));
    if(!cands.length)cands=[...active];
    // Tag limieten eerst toepassen (voor algemene pool)
    if(tagLimits.length){const wl=cands.filter(dish=>dish.tags.every(tag=>{const lim=tagLimits.find(tl=>tl.tag.toLowerCase()===tag.toLowerCase());if(!lim)return true;return(tagCounts[tag.toLowerCase()]||0)<lim.maxPerWeek;}));if(wl.length)cands=wl;}
    // Dagvoorkeur heeft altijd prioriteit - overschrijft tag limiet filter als er kandidaten zijn
    if(pref){const m=cands.filter(d=>d.tags.some(t=>t.toLowerCase()===pref.tag.toLowerCase()));if(m.length)cands=m;}
    if(days.length){const last=dishes.find(d=>d.id===days[days.length-1].dishId);if(last){const nr=cands.filter(d=>!d.tags.some(t=>last.tags.includes(t)));if(nr.length)cands=nr;}}
    const chosen=cands[Math.floor(Math.random()*cands.length)];
    days.push({dayOfWeek:dayIdx,dishId:chosen.id,isLocked:false});
    used.add(chosen.id);
    chosen.tags.forEach(t=>{const k=t.toLowerCase();tagCounts[k]=(tagCounts[k]||0)+1;});
  }
  return{id:genId(),weekNumber:getWeekNumber(new Date()),year:new Date().getFullYear(),days,createdAt:new Date().toISOString(),confirmed:false};
}

function generateShoppingList(menu,dishes){
  const map=new Map();
  menu.days.forEach(day=>{const dish=dishes.find(d=>d.id===day.dishId);if(!dish)return;dish.ingredients.forEach(ing=>{const k=ing.name.toLowerCase().trim();if(!map.has(k))map.set(k,{name:ing.name,category:ing.category||'overig',checked:false,isManual:false});});});
  return{id:genId(),weekMenuId:menu.id,items:[...map.values()].sort((a,b)=>a.category.localeCompare(b.category))};
}

// ‚îÄ‚îÄ‚îÄ Event Handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleGenerate(){
  const recentIds=[];
  state.menus.slice(-2).forEach(m=>m.days.forEach(d=>recentIds.push(d.dishId)));
  const menu=generateWeekMenu(state.dishes,recentIds,state.dayPrefs,state.tagLimits,state.cookingDays);
  if(!menu){notify('Voeg eerst gerechten toe!');return;}
  const menus=[...state.menus,menu];
  save('wm-menus',menus);
  setState({menus});
  notify('Nieuw menu gegenereerd! üé≤');
}

function handleConfirmMenu(){
  const menus=state.menus.map((m,i)=>i===state.menus.length-1?{...m,confirmed:true}:m);
  const menu=menus[menus.length-1];
  const shopping=generateShoppingList(menu,state.dishes);
  save('wm-menus',menus);save('wm-shopping',shopping);
  setState({menus,shopping});
  notify('Menu bevestigd! üõí');
}

function handleRerollDay(dayIndex){
  const menu={...state.menus[state.menus.length-1]};
  const day=menu.days[dayIndex];
  const usedIds=menu.days.map(d=>d.dishId);
  const pref=state.dayPrefs.find(p=>p.dayOfWeek===day.dayOfWeek);
  let cands=state.dishes.filter(d=>d.isActive&&!usedIds.includes(d.id));
  if(!cands.length)cands=state.dishes.filter(d=>d.isActive&&d.id!==day.dishId);
  if(pref){const m=cands.filter(d=>d.tags.some(t=>t.toLowerCase()===pref.tag.toLowerCase()));if(m.length)cands=m;}
  if(!cands.length)return;
  const chosen=cands[Math.floor(Math.random()*cands.length)];
  menu.days=menu.days.map((d,i)=>i===dayIndex?{...d,dishId:chosen.id}:d);
  const menus=state.menus.map((m,i)=>i===state.menus.length-1?menu:m);
  save('wm-menus',menus);setState({menus});
  notify('Nieuw gerecht! üé≤');
}

function handleToggleLock(dayIndex){
  const menu={...state.menus[state.menus.length-1]};
  menu.days=menu.days.map((d,i)=>i===dayIndex?{...d,isLocked:!d.isLocked}:d);
  const menus=state.menus.map((m,i)=>i===state.menus.length-1?menu:m);
  save('wm-menus',menus);setState({menus});
}

function handleRegenerateKeepLocked(){
  const old=state.menus[state.menus.length-1];
  const recentIds=[];state.menus.slice(-2).forEach(m=>m.days.forEach(d=>recentIds.push(d.dishId)));
  const locked=old.days.filter(d=>d.isLocked);
  const unlockedDays=state.cookingDays.filter(di=>!locked.find(l=>l.dayOfWeek===di));
  const lockedIds=locked.map(d=>d.dishId);
  const active=state.dishes.filter(d=>d.isActive);
  const fresh=active.filter(d=>!recentIds.includes(d.id)&&!lockedIds.includes(d.id));
  let pool=fresh.length>=unlockedDays.length?[...fresh]:active.filter(d=>!lockedIds.includes(d.id));
  if(!pool.length)pool=[...active];
  const newDays=[];const used=new Set(lockedIds);const tagCounts={};
  locked.forEach(l=>{const dish=state.dishes.find(d=>d.id===l.dishId);if(dish)dish.tags.forEach(t=>{const k=t.toLowerCase();tagCounts[k]=(tagCounts[k]||0)+1;});});
  for(const dayIdx of state.cookingDays){
    const lk=locked.find(l=>l.dayOfWeek===dayIdx);
    if(lk){newDays.push(lk);continue;}
    let cands=pool.filter(d=>!used.has(d.id));
    if(!cands.length)cands=active.filter(d=>!used.has(d.id));
    if(!cands.length)cands=[...active];
    const pref=state.dayPrefs.find(p=>p.dayOfWeek===dayIdx);
    if(state.tagLimits.length){const wl=cands.filter(dish=>dish.tags.every(tag=>{const lim=state.tagLimits.find(tl=>tl.tag.toLowerCase()===tag.toLowerCase());if(!lim)return true;return(tagCounts[tag.toLowerCase()]||0)<lim.maxPerWeek;}));if(wl.length)cands=wl;}
    if(pref){const m=cands.filter(d=>d.tags.some(t=>t.toLowerCase()===pref.tag.toLowerCase()));if(m.length)cands=m;}
    if(newDays.length){const last=state.dishes.find(d=>d.id===newDays[newDays.length-1].dishId);if(last){const nr=cands.filter(d=>!d.tags.some(t=>last.tags.includes(t)));if(nr.length)cands=nr;}}
    const chosen=cands[Math.floor(Math.random()*cands.length)];
    newDays.push({dayOfWeek:dayIdx,dishId:chosen.id,isLocked:false});
    used.add(chosen.id);
    chosen.tags.forEach(t=>{const k=t.toLowerCase();tagCounts[k]=(tagCounts[k]||0)+1;});
  }
  const menu={...old,days:newDays};
  const menus=state.menus.map((m,i)=>i===state.menus.length-1?menu:m);
  save('wm-menus',menus);setState({menus});notify('Hergegenereerd! üîÑ');
}

function handlePickDish(dayIndex){setState({pickerDay:dayIndex,pickerSearch:''});}
function handleSelectDish(dishId){
  const menu={...state.menus[state.menus.length-1]};
  menu.days=menu.days.map((d,i)=>i===state.pickerDay?{...d,dishId,isLocked:true}:d);
  const menus=state.menus.map((m,i)=>i===state.menus.length-1?menu:m);
  save('wm-menus',menus);setState({menus,pickerDay:null});notify('Gerecht gekozen! ‚úèÔ∏è');
}

// Dish CRUD
function handleSaveDish(){
  const f=state.dishForm;if(!f||!f.name.trim()){notify('Vul een naam in!');return;}
  let dishes;
  if(f.id){
    dishes=state.dishes.map(d=>d.id===f.id?{...d,name:f.name.trim(),tags:f.tags,ingredients:f.ingredients}:d);
    notify('Gerecht bijgewerkt ‚úèÔ∏è');
  }else{
    dishes=[...state.dishes,{id:genId(),name:f.name.trim(),tags:f.tags,ingredients:f.ingredients,isActive:true,createdAt:new Date().toISOString()}];
    notify('Gerecht toegevoegd! üçΩÔ∏è');
  }
  save('wm-dishes',dishes);setState({dishes,dishForm:null});
}

function handleDeleteDish(id){
  const dishes=state.dishes.filter(d=>d.id!==id);
  save('wm-dishes',dishes);setState({dishes,deleteTarget:null});notify('Gerecht verwijderd');
}

function handleToggleActive(id){
  const dishes=state.dishes.map(d=>d.id===id?{...d,isActive:!d.isActive}:d);
  save('wm-dishes',dishes);setState({dishes});
}

// Shopping
function handleToggleShopItem(idx){
  const s={...state.shopping};s.items=s.items.map((it,i)=>i===idx?{...it,checked:!it.checked}:it);
  save('wm-shopping',s);setState({shopping:s});
}

function handleAddManualItem(name){
  if(!name.trim())return;
  const s={...state.shopping};s.items=[...s.items,{name:name.trim(),category:'overig',checked:false,isManual:true}];
  save('wm-shopping',s);setState({shopping:s});notify('Item toegevoegd');
}

function handleRegenerateShoppingList(){
  const menu=state.menus[state.menus.length-1];
  if(!menu)return;
  const s=generateShoppingList(menu,state.dishes);
  save('wm-shopping',s);setState({shopping:s});notify('Lijst vernieuwd! üõí');
}

// Settings
function handleToggleCookingDay(dayIdx){
  let cd=[...state.cookingDays];
  if(cd.includes(dayIdx))cd=cd.filter(d=>d!==dayIdx);
  else{cd.push(dayIdx);cd.sort((a,b)=>a-b);}
  if(!cd.length){notify('Minimaal 1 kookdag!');return;}
  save('wm-cookingdays',cd);setState({cookingDays:cd});
  notify(DAYS_SHORT[dayIdx]+(cd.includes(dayIdx)?' aan':' uit'));
}

function handleAddPref(dayIdx,tag){
  if(!tag)return;
  let prefs=state.dayPrefs.filter(p=>p.dayOfWeek!==dayIdx);
  prefs.push({dayOfWeek:dayIdx,tag});
  save('wm-prefs',prefs);setState({dayPrefs:prefs});notify('Voorkeur opgeslagen');
}
function handleRemovePref(dayIdx){
  const prefs=state.dayPrefs.filter(p=>p.dayOfWeek!==dayIdx);
  save('wm-prefs',prefs);setState({dayPrefs:prefs});
}

function handleAddTagLimit(tag,max){
  if(!tag||!max)return;
  let tl=state.tagLimits.filter(l=>l.tag!==tag);
  tl.push({tag,maxPerWeek:parseInt(max)});
  save('wm-taglimits',tl);setState({tagLimits:tl});notify('Limiet opgeslagen');
}
function handleRemoveTagLimit(tag){
  const tl=state.tagLimits.filter(l=>l.tag!==tag);
  save('wm-taglimits',tl);setState({tagLimits:tl});
}

// ‚îÄ‚îÄ‚îÄ Render Functions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHome(){
  const menu=state.menus.length?state.menus[state.menus.length-1]:null;
  if(!menu){
    return `<div class="empty"><div class="empty-emoji">üç≥</div><div class="empty-text">Nog geen weekmenu</div><div class="empty-hint">Genereer je eerste menu!</div></div>
    <button class="btn-primary" onclick="handleGenerate()" style="margin-top:16px">${icon('refresh',20,'#fff')} Genereer weekmenu</button>`;
  }
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <h2 class="section-title" style="margin:0">Week ${menu.weekNumber}</h2>
    <div style="display:flex;gap:8px">
      <button class="btn-icon" onclick="handleRegenerateKeepLocked()" title="Hergenereer">${icon('refresh',18,'#E07A5F')}</button>
    </div></div>`;
  h+=`<div>`;
  menu.days.forEach((day,i)=>{
    const dish=state.dishes.find(d=>d.id===day.dishId);
    const pref=state.dayPrefs.find(p=>p.dayOfWeek===day.dayOfWeek);
    h+=`<div class="menu-card${day.isLocked?' locked':''}" style="animation:menuPop .3s ease ${i*0.05}s both">
      <div class="menu-card-top">
        <div><span class="menu-day">${DAYS[day.dayOfWeek]}</span>${pref?`<span class="pref-badge">${esc(pref.tag)}</span>`:''}</div>
        <div style="display:flex;gap:4px">
          <button class="btn-tiny" onclick="handlePickDish(${i})" title="Kies gerecht">${icon('pencil',16,'#81B29A')}</button>
          <button class="btn-tiny" onclick="handleToggleLock(${i})" title="${day.isLocked?'Ontgrendel':'Vergrendel'}">${icon(day.isLocked?'lock':'unlock',16,day.isLocked?'#E07A5F':'#bbb')}</button>
          ${!day.isLocked?`<button class="btn-tiny" onclick="handleRerollDay(${i})" title="Ander gerecht">${icon('dice',16,'#81B29A')}</button>`:''}
        </div>
      </div>
      <div class="menu-dish">${esc(dish?dish.name:'Onbekend gerecht')}</div>
      ${dish&&dish.tags.length?`<div style="margin-top:4px">${dish.tags.map(t=>`<span class="tag-small">${esc(t)}</span>`).join('')}</div>`:''}
    </div>`;
  });
  h+=`</div>`;
  if(!menu.confirmed){
    h+=`<button class="btn-secondary" onclick="handleConfirmMenu()" style="margin-top:12px">${icon('check',20,'#fff')} Menu bevestigen</button>`;
  }else{
    h+=`<div style="text-align:center;color:#81B29A;font-weight:600;padding:12px;font-size:14px">‚úÖ Menu bevestigd</div>`;
  }
  h+=`<button class="btn-primary" onclick="handleGenerate()" style="margin-top:8px">${icon('refresh',20,'#fff')} Nieuw menu genereren</button>`;
  return h;
}

function renderDishes(){
  if(state.dishForm)return renderDishForm();
  const allTags=[...new Set(state.dishes.flatMap(d=>d.tags))];
  const search=state.dishSearch.toLowerCase().trim();
  let filtered=state.dishes;
  if(state.filterTag)filtered=filtered.filter(d=>d.tags.includes(state.filterTag));
  if(search)filtered=filtered.filter(d=>d.name.toLowerCase().includes(search)||d.ingredients.some(ing=>ing.name.toLowerCase().includes(search)));

  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <h2 class="section-title" style="margin:0">Gerechten <span style="color:#bbb;font-weight:400;font-size:14px">(${state.dishes.length})</span></h2>
    <button class="btn-small" onclick="setState({dishForm:{name:'',tags:[],ingredients:[]}})">${icon('plus',16)} Nieuw</button>
  </div>`;

  // Search bar
  h+=`<div class="search-wrap"><span class="search-icon">${icon('search',16,'#bbb')}</span>
    <input class="search-bar" placeholder="Zoek op naam of ingredi√´nt..." value="${esc(state.dishSearch)}" oninput="setState({dishSearch:this.value})"></div>`;

  // Tag filter
  if(allTags.length){
    h+=`<div class="filter-row"><button class="tag-option${!state.filterTag?' active':''}" onclick="setState({filterTag:null})">Alle</button>`;
    allTags.forEach(t=>{h+=`<button class="tag-option${state.filterTag===t?' active':''}" onclick="setState({filterTag:'${esc(t)}'})">${esc(t)}</button>`;});
    h+=`</div>`;
  }

  if(!filtered.length){
    h+=`<div class="empty"><div class="empty-emoji">üçΩÔ∏è</div><div class="empty-text">Geen gerechten gevonden</div></div>`;
  }else{
    filtered.forEach(d=>{
      h+=`<div class="dish-item${d.isActive?'':' inactive'}">
        <div class="dish-info">
          <div class="dish-name">${esc(d.name)}</div>
          <div style="display:flex;flex-wrap:wrap;gap:4px">${d.tags.map(t=>`<span class="tag-small">${esc(t)}</span>`).join('')}</div>
          ${d.ingredients.length?`<div class="ing-row">${d.ingredients.map(ing=>`<span class="ing-chip">${esc(ing.name)}</span>`).join('')}</div>`:''}
        </div>
        <div class="dish-actions">
          <button class="btn-tiny" onclick="handleToggleActive('${d.id}')" title="${d.isActive?'Deactiveer':'Activeer'}" style="opacity:${d.isActive?1:.5}">${d.isActive?'‚úÖ':'‚è∏Ô∏è'}</button>
          <button class="btn-tiny" onclick="editDish('${d.id}')">${icon('edit',16,'#81B29A')}</button>
          <button class="btn-tiny" onclick="setState({deleteTarget:'${d.id}'})">${icon('trash',16,'#E07A5F')}</button>
        </div>
      </div>`;
    });
  }
  return h;
}

function renderDishForm(){
  const f=state.dishForm;
  let h=`<div class="form-card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2 style="font-size:17px;font-weight:700">${f.id?'Bewerk gerecht':'Nieuw gerecht'}</h2>
      <button class="btn-tiny" onclick="setState({dishForm:null})">${icon('x',20,'#999')}</button>
    </div>
    <label class="label">Naam</label>
    <input class="input" id="df-name" placeholder="bv. Spaghetti Bolognese" value="${esc(f.name)}" oninput="state.dishForm.name=this.value">
    <label class="label">Tags</label>
    <div class="tag-select">`;
  TAG_OPTIONS.forEach(t=>{
    const active=f.tags.includes(t);
    h+=`<button class="tag-option${active?' active':''}" onclick="toggleDishTag('${t}')">${esc(t)}</button>`;
  });
  h+=`</div>
    <label class="label">Ingredi√´nten</label>`;
  if(f.ingredients.length){
    h+=`<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px">`;
    f.ingredients.forEach((ing,i)=>{
      h+=`<span style="display:inline-flex;align-items:center;gap:4px;background:#F0EDE6;padding:4px 10px;border-radius:8px;font-size:13px">${esc(ing.name)}<button onclick="removeDishIng(${i})" style="background:none;border:none;color:#E07A5F;font-size:16px;line-height:1;cursor:pointer">√ó</button></span>`;
    });
    h+=`</div>`;
  }
  // Autocomplete
  const acQuery=(state.acQuery||'').toLowerCase().trim();
  const knownIngs=(()=>{const map=new Map();state.dishes.forEach(d=>{d.ingredients.forEach(ing=>{const k=ing.name.toLowerCase().trim();if(!map.has(k))map.set(k,{name:ing.name,category:ing.category||'overig'});});});return[...map.values()];})();
  const acSuggestions=acQuery.length>=1?knownIngs.filter(ki=>ki.name.toLowerCase().includes(acQuery)&&!f.ingredients.some(ei=>ei.name.toLowerCase()===ki.name.toLowerCase())).slice(0,5):[];

  h+=`<div style="display:flex;gap:6px;align-items:flex-start">
    <div style="flex:1;position:relative">
      <input class="input" id="df-ing" placeholder="Ingredi√´nt" value="${esc(state.acQuery||'')}" oninput="state.acQuery=this.value;render()" onkeydown="if(event.key==='Enter'){event.preventDefault();addDishIng();}" autocomplete="off">`;
  if(acSuggestions.length){
    window._acCache=acSuggestions.map(s=>({name:s.name,category:s.category}));
    h+=`<div class="autocomplete">`;
    acSuggestions.forEach((s,si)=>{
      h+=`<div class="ac-item" onpointerdown="event.preventDefault();selectAutoComplete(_acCache[${si}].name,_acCache[${si}].category)">${esc(s.name)}<span class="ac-cat">${esc(s.category)}</span></div>`;
    });
    h+=`</div>`;
  }
  h+=`</div>
    <select class="select" id="df-cat" style="width:68px;padding:10px 4px;font-size:11px">`;
  ING_CATS.forEach(c=>{h+=`<option value="${c}">${c}</option>`;});
  h+=`</select>
    <button onclick="addDishIng()" style="width:36px;height:36px;min-width:36px;border-radius:10px;background:#81B29A;border:none;display:flex;align-items:center;justify-content:center;flex-shrink:0" title="Voeg toe">${icon('plus',18,'#fff')}</button>
  </div>
  <button class="btn-secondary" onclick="handleSaveDish()" style="margin-top:16px">${icon('check',18,'#fff')} Opslaan</button>
  </div>`;
  return h;
}

// Edit dish by ID - safe approach without inline JSON
function editDish(id){
  const d=state.dishes.find(dd=>dd.id===id);
  if(!d)return;
  setState({dishForm:{id:d.id,name:d.name,tags:[...d.tags],ingredients:d.ingredients.map(ing=>({...ing}))}});
}

function toggleDishTag(tag){
  const f=state.dishForm;
  if(f.tags.includes(tag))f.tags=f.tags.filter(t=>t!==tag);
  else f.tags=[...f.tags,tag];
  render();
}
function removeDishIng(i){state.dishForm.ingredients.splice(i,1);render();}
function addDishIng(){
  const el=document.getElementById('df-ing');const cat=document.getElementById('df-cat');
  const val=state.acQuery||'';
  if(!val.trim())return;
  state.dishForm.ingredients.push({name:val.trim(),category:cat?cat.value:'overig'});
  state.acQuery='';render();
}
function selectAutoComplete(name,category){
  state.dishForm.ingredients.push({name,category});
  state.acQuery='';render();
}

function renderShopping(){
  const s=state.shopping;
  if(!s||!s.items||!s.items.length){
    return `<div class="empty"><div class="empty-emoji">üõí</div><div class="empty-text">Geen boodschappenlijst</div><div class="empty-hint">Bevestig eerst een weekmenu</div></div>`;
  }
  let h=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <h2 class="section-title" style="margin:0">Boodschappen <span style="color:#bbb;font-weight:400;font-size:14px">(${s.items.filter(i=>!i.checked).length}/${s.items.length})</span></h2>
    <button class="btn-small" onclick="handleRegenerateShoppingList()">${icon('refresh',14)} Vernieuw</button>
  </div>`;
  // Group by category
  const cats={};s.items.forEach((it,idx)=>{const c=it.category||'overig';if(!cats[c])cats[c]=[];cats[c].push({...it,idx});});
  const CAT_EMOJI={groenten:'ü•¨',fruit:'üçé',vlees:'ü•©',vis:'üêü',zuivel:'üßÄ',droog:'üåæ',sauzen:'ü´ô',kruiden:'üßÇ',overig:'üì¶'};
  Object.keys(cats).sort().forEach(cat=>{
    h+=`<div class="shop-cat-header">${CAT_EMOJI[cat]||'üì¶'} ${esc(cat)}</div>`;
    cats[cat].forEach(it=>{
      h+=`<div class="shop-item" onclick="handleToggleShopItem(${it.idx})" style="cursor:pointer">
        <div class="shop-check${it.checked?' checked':''}">${it.checked?icon('check',14,'#fff'):''}</div>
        <span class="shop-name${it.checked?' checked':''}">${esc(it.name)}</span>
      </div>`;
    });
  });
  // Manual add
  h+=`<div style="display:flex;gap:8px;margin-top:16px">
    <input class="input" id="shop-add" placeholder="Extra item toevoegen..." style="flex:1" onkeydown="if(event.key==='Enter'){event.preventDefault();var el=document.getElementById('shop-add');handleAddManualItem(el.value);el.value='';}">
    <button class="btn-small" onclick="var el=document.getElementById('shop-add');handleAddManualItem(el.value);el.value='';">+ Voeg toe</button>
  </div>`;
  return h;
}

function renderSettings(){
  let h='';
  // Cooking days
  h+=`<h2 class="section-title">Kookdagen</h2>
    <p class="hint">Op welke dagen kook je? Niet-geselecteerde dagen worden overgeslagen.</p>
    <div class="cooking-days">`;
  DAYS_SHORT.forEach((d,i)=>{
    h+=`<button class="day-toggle${state.cookingDays.includes(i)?' active':''}" onclick="handleToggleCookingDay(${i})">${d}</button>`;
  });
  h+=`</div>`;

  // Day preferences
  h+=`<h2 class="section-title">Dagvoorkeuren</h2>
    <p class="hint">Stel een gewenst type gerecht in per dag.</p>`;
  state.cookingDays.forEach(i=>{
    const pref=state.dayPrefs.find(p=>p.dayOfWeek===i);
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <span style="font-size:13px;font-weight:600;width:80px">${DAYS[i]}</span>`;
    if(pref){
      h+=`<span class="tag">${esc(pref.tag)}</span>
        <button class="btn-tiny" onclick="handleRemovePref(${i})">${icon('x',14,'#E07A5F')}</button>`;
    }else{
      h+=`<select class="select" style="flex:1;padding:8px" onchange="if(this.value)handleAddPref(${i},this.value)">
        <option value="">‚Äî geen ‚Äî</option>`;
      TAG_OPTIONS.forEach(t=>{h+=`<option value="${t}">${t}</option>`;});
      h+=`</select>`;
    }
    h+=`</div>`;
  });

  // Tag limits
  h+=`<h2 class="section-title" style="margin-top:20px">Tag limieten</h2>
    <p class="hint">Beperk hoe vaak een type per week mag voorkomen.</p>`;
  state.tagLimits.forEach(tl=>{
    h+=`<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
      <span class="tag">${esc(tl.tag)}</span><span style="font-size:13px">max ${tl.maxPerWeek}√ó/week</span>
      <button class="btn-tiny" onclick="handleRemoveTagLimit('${esc(tl.tag)}')">${icon('x',14,'#E07A5F')}</button>
    </div>`;
  });
  h+=`<div style="display:flex;gap:8px;margin-top:8px">
    <select class="select" id="tl-tag" style="flex:1;padding:8px"><option value="">Kies tag...</option>`;
  TAG_OPTIONS.filter(t=>!state.tagLimits.find(l=>l.tag===t)).forEach(t=>{h+=`<option value="${t}">${t}</option>`;});
  h+=`</select>
    <select class="select" id="tl-max" style="width:70px;padding:8px"><option value="1">1√ó</option><option value="2" selected>2√ó</option><option value="3">3√ó</option></select>
    <button class="btn-small" onclick="var t=document.getElementById('tl-tag'),m=document.getElementById('tl-max');handleAddTagLimit(t.value,m.value)">+ Voeg toe</button>
  </div>`;

  // History
  h+=`<h2 class="section-title" style="margin-top:20px">Historie</h2>`;
  const confirmed=state.menus.filter(m=>m.confirmed).slice(-5).reverse();
  if(!confirmed.length){
    h+=`<p class="hint">Nog geen bevestigde menu's.</p>`;
  }else{
    confirmed.forEach(m=>{
      h+=`<div class="history-card"><div class="history-week">Week ${m.weekNumber} (${m.year})</div>`;
      m.days.forEach(d=>{
        const dish=state.dishes.find(dd=>dd.id===d.dishId);
        h+=`<div class="history-day">${DAYS[d.dayOfWeek]}: ${esc(dish?dish.name:'?')}</div>`;
      });
      h+=`</div>`;
    });
  }
  return h;
}

// ‚îÄ‚îÄ‚îÄ Modals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderModals(){
  let h='';
  // Dish picker
  if(state.pickerDay!==null){
    const search=state.pickerSearch.toLowerCase().trim();
    let dishes=state.dishes.filter(d=>d.isActive);
    if(search)dishes=dishes.filter(d=>d.name.toLowerCase().includes(search)||d.tags.some(t=>t.includes(search))||d.ingredients.some(ing=>ing.name.toLowerCase().includes(search)));
    h+=`<div class="modal-overlay" onclick="if(event.target===this)setState({pickerDay:null})">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">Kies een gerecht</h3>
          <button class="btn-tiny" onclick="setState({pickerDay:null})">${icon('x',20,'#999')}</button>
        </div>
        <input class="picker-search" placeholder="Zoek op naam, tag of ingredi√´nt..." value="${esc(state.pickerSearch)}" oninput="setState({pickerSearch:this.value})" autofocus>
        <div class="picker-list">`;
    dishes.forEach(d=>{
      h+=`<button class="picker-item" onclick="handleSelectDish('${d.id}')">
        <div class="picker-dish-name">${esc(d.name)}</div>
        <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:2px">${d.tags.map(t=>`<span class="tag-small">${esc(t)}</span>`).join('')}</div>
        <div class="picker-ingredients">${d.ingredients.map(ing=>{
          const match=search&&ing.name.toLowerCase().includes(search);
          return`<span class="picker-ing${match?' match'
          :''}">${esc(ing.name)}</span>`;
        }).join('')}</div>
      </button>`;
    });
    if(!dishes.length)h+=`<div style="text-align:center;padding:32px;color:#bbb">Geen gerechten gevonden</div>`;
    h+=`</div></div></div>`;
  }

  // Delete confirmation
  if(state.deleteTarget){
    const d=state.dishes.find(dd=>dd.id===state.deleteTarget);
    h+=`<div class="modal-overlay center" onclick="if(event.target===this)setState({deleteTarget:null})">
      <div class="confirm-box">
        <div class="confirm-title">Gerecht verwijderen?</div>
        <div class="confirm-msg">"${esc(d?d.name:'')}" wordt permanent verwijderd.</div>
        <div class="confirm-btns">
          <button class="confirm-cancel" onclick="setState({deleteTarget:null})">Annuleer</button>
          <button class="confirm-delete" onclick="handleDeleteDish('${state.deleteTarget}')">Verwijder</button>
        </div>
      </div>
    </div>`;
  }
  return h;
}

// ‚îÄ‚îÄ‚îÄ Main Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(){
  // Save focused element info before re-render
  const activeId=document.activeElement?document.activeElement.id:null;
  const activeTag=document.activeElement?document.activeElement.tagName:null;
  let cursorPos=null;
  if(activeId&&(activeTag==='INPUT'||activeTag==='TEXTAREA')){try{cursorPos=document.activeElement.selectionStart;}catch(e){}}

  const tabs=[
    {id:'home',icon:'home',label:'Menu'},
    {id:'dishes',icon:'dish',label:'Gerechten'},
    {id:'cart',icon:'cart',label:'Boodschappen'},
    {id:'settings',icon:'settings',label:'Instellingen'},
  ];
  let content='';
  if(state.tab==='home')content=renderHome();
  else if(state.tab==='dishes')content=renderDishes();
  else if(state.tab==='cart')content=renderShopping();
  else if(state.tab==='settings')content=renderSettings();

  document.getElementById('root').innerHTML=`
    <div class="app">
      ${state.notification?`<div class="toast">${esc(state.notification)}</div>`:''}
      <header class="header">
        <span class="header-emoji">üç≥</span>
        <h1 class="header-title">Weekmenu</h1>
        <span class="header-week">Week ${getWeekNumber(new Date())}</span>
        <div id="sync-indicator" title="${{'ok':'Gesynchroniseerd','syncing':'Synchroniseren...','offline':'Offline (lokaal opgeslagen)'}[syncStatus]||'Niet geconfigureerd'}" style="width:10px;height:10px;border-radius:50%;background:${{'ok':'#81B29A','syncing':'#F2CC8F','offline':'#E07A5F'}[syncStatus]||'#bbb'};flex-shrink:0;transition:background .4s"></div>
      </header>
      <main class="main">${content}</main>
      <nav class="nav">
        ${tabs.map(t=>`<button class="nav-btn${state.tab===t.id?' active':''}" onclick="setState({tab:'${t.id}',dishForm:null,dishSearch:'',filterTag:null})">
          ${icon(t.icon,22,state.tab===t.id?'#E07A5F':'#bbb')}
          <span class="nav-label" style="color:${state.tab===t.id?'#E07A5F':'#bbb'}">${t.label}</span>
        </button>`).join('')}
      </nav>
      ${renderModals()}
    </div>`;

  // Restore focus and cursor position after re-render
  if(activeId){
    const el=document.getElementById(activeId);
    if(el){el.focus();if(cursorPos!==null){try{el.setSelectionRange(cursorPos,cursorPos);}catch(e){}}}
  }
}

// ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
render();

// Laad data van Supabase alleen bij eerste opstart (v√≥√≥r enige gebruikersinteractie)
// Zodra de gebruiker iets doet, stoppen we met ophalen van Supabase om re-renders te vermijden
let _appHasInteracted = false;
const _origSetState = setState;
window.setState = function(patch){ _appHasInteracted = true; _origSetState(patch); };

loadFromSupabase();

if(SUPABASE_URL !== 'JOUW_SUPABASE_URL'){
  sb.subscribe((record) => {
    if(!record) return;
    const keyMap = { dishes:'wm-dishes', menus:'wm-menus', shopping:'wm-shopping', prefs:'wm-prefs', taglimits:'wm-taglimits', cookingdays:'wm-cookingdays' };
    const localKey = keyMap[record.key];
    if(!localKey) return;
    // Negeer eigen echo: tel pending writes af, render alleen als het een externe update is
    if(_ownWrites[record.key] > 0){
      _ownWrites[record.key]--;
      setSyncStatus('ok');
      return;
    }
    saveLocal(localKey, record.data);
    if(record.key==='dishes') state.dishes = record.data;
    else if(record.key==='menus') state.menus = record.data;
    else if(record.key==='shopping') state.shopping = record.data;
    else if(record.key==='prefs') state.dayPrefs = record.data;
    else if(record.key==='taglimits') state.tagLimits = record.data;
    else if(record.key==='cookingdays') state.cookingDays = record.data;
    setSyncStatus('ok');
    render();
  });
}
</script>
</body>
</html>